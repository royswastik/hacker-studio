<html>
  <script type="text/javascript">
  /**
   * This file is used as a background service to evaluate a submission
   */
    const ipc = require('electron').ipcRenderer;
    const fs= require('fs');
    let path=require('path');
    const glob= require('glob');
    var CryptoJS = require("crypto-js");
    const BrowserWindow = require('electron').remote.BrowserWindow;

    ipc.on('import-problems', function (event, filePaths, fromWindowId) {
          const fromWindow = BrowserWindow.fromId(fromWindowId);
          let workSpaceDir = "file:///D:/workspace/desktop/hacker-studio/src/data";
          for(var i=0;i < filePaths.length;i++){
              let filePath = filePaths[i].replace(new RegExp("\\".replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), 'g'), "/");
              console.log(filePath);
              let newFile=fs.readFileSync('file:///'+filePath);
              let content =  newFile.toString();
              console.log(content);
              let meta_file_out=fs.readFileSync(workSpaceDir+"/meta.json");
              let metaObj =  JSON.parse(meta_file_out.toString());
              // Decrypt 
            //   let bytes  = CryptoJS.AES.decrypt(content.toString(), 'HackerStudio Secret Key');
            //   content = bytes.toString(CryptoJS.enc.Utf8);
              
              let jsonObj = JSON.parse(content);

              let categoryObj = jsonObj["category"];
              let problemObj = jsonObj["problem"];
              let testCaseObj = jsonObj["test-cases"];

              let categoryList = [];
              let categoryAlreadyPresentId = (function(){
                    let returnObj = null;
                    for(var i=0;i<metaObj["categories"].length;i++){
                        if(metaObj["categories"]["name"].trim().toLowerCase() == categoryObj["name"].trim().toLowerCase()){
                            returnObj = metaObj["categories"]["id"].trim().toLowerCase();
                            categoryList.push(metaObj["categories"]["id"]);
                        }
                    }
                    return returnObj;
              })();
              let categoryId = (categoryAlreadyPresentId != null)?categoryAlreadyPresentId:
                (function(){
                    categoryList.sort();
                    let lastCategory = (categoryList.length > 0)?categoryList[categoryList.length-1]:0;
                    let nextCategory = (parseInt(lastCategory) != undefined)?(lastCategory+1):lastCategory+"1";
                    fs.mkdirSync(workSpaceDir+"/"+nextCategory);
                    fs.writeFileSync(workSpaceDir+"/"+nextCategory+"/"+meta.json, '{"problem-list": []}');
                    return nextCategory;
                })();
              let problemList = [];
              let meta_file_out_cat=fs.readFileSync(workSpaceDir+"/"+categoryId+"/meta.json");
              let metaCatObj =  JSON.parse(meta_file_out_cat.toString());
              let problemAlreadyPresentId = (function(){
                  let returnObj = null;
                    for(var i=0;i<metaCatObj["problem-list"].length;i++){
                        if(metaCatObj["problem-list"]["name"].trim().toLowerCase() == problemObj["name"].trim().toLowerCase()){
                            returnObj = metaCatObj["problem-list"]["id"].trim().toLowerCase();
                            problemList.push(metaCatObj["problem-list"]["id"]);
                        }
                    }
                    return returnObj;
              });

              if(problemAlreadyPresentId != null){
                  /**
                   * Problem Already Present, return status
                   */
              }
              let problemId = (function(){
                    problemList.sort();
                    let lastProblem = (problemList.length > 0)?problemList[problemList.length-1]:0;
                    let nextProblem = (parseInt(lastProblem) != undefined)?(lastProblem+1):lastProblem+"1";
                    fs.mkdirSync(workSpaceDir+"/"+categoryId+"/"+nextProblem);
                    let testCasesArray = [];
                    for(var testCase in testCaseObj){
                        testCasesArray.push(testCase);
                    }
                    fs.writeFileSync(workSpaceDir+"/"+categoryId+"/"+nextProblem+"/meta.json", '\
                        {\
                            "id" : "'+nextProblem+'",\
                            "name": "'+problemObj["name"]+'",\
                            "problem-statement": "'+problemObj["[problem-statement]"]+'",\
                            "input-format": "'+problemObj["[input-format]"]+'",\
                            "output-format": "'+problemObj["[output-format]"]+'",\
                            "sample-input": "'+problemObj["[sample-input]"]+'",\
                            "sample-output": "'+problemObj["[sample-output]"]+'",\
                            "test-cases": '+testCasesArray.toString()+'\
                        }\
                    ');
                    return nextProblem;
                })();
                for(var testCase in testCaseObj){
                    fs.writeFileSync(workSpaceDir+"/"+categoryId+"/"+nextProblem+"/"+testCase+".in", testCase["input"]);
                    fs.writeFileSync(workSpaceDir+"/"+categoryId+"/"+nextProblem+"/"+testCase+".out", testCase["output"]);
                }

            
                 fromWindow.webContents.send('problem-imported', filePaths[i],jsonObj);

              // Encrypt 
         //     let ciphertext = CryptoJS.AES.encrypt(content, 'HackerStudio Secret Key');
              
          }
         
          
    });
    
  </script>
</html>